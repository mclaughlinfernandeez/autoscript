
import React, { useState, useCallback } from 'react';
import { ConversionOptions, InputFileType, OutputFileType, InputSource, PublicDataset } from './types';
import { generateConversionScript } from './services/geminiService';
import Header from './components/Header';
import InputSourcePanel from './components/InputSourcePanel';
import ConversionOptionsPanel from './components/ConversionOptionsPanel';
import ResultDisplay from './components/ResultDisplay';
import Loader from './components/Loader';

const App: React.FC = () => {
    const [inputSource, setInputSource] = useState<InputSource>({ type: 'local', file: null });
    const [generatedScript, setGeneratedScript] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string | null>(null);

    const isReadyToConfigure = inputSource.type === 'local' ? !!inputSource.file : !!inputSource.dataset;

    const handleGenerateScript = useCallback(async (options: ConversionOptions, inputType: InputFileType, outputTypes: OutputFileType[]) => {
        if (!isReadyToConfigure) {
            setError("Please select an input source first.");
            return;
        }

        setIsLoading(true);
        setError(null);
        setGeneratedScript('');

        try {
            const script = await generateConversionScript(inputSource, inputType, outputTypes, options);
            setGeneratedScript(script);
        } catch (e) {
            console.error(e);
            const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
            setError(`Failed to generate script. Please check the console for details. Error: ${errorMessage}`);
        } finally {
            setIsLoading(false);
        }
    }, [inputSource, isReadyToConfigure]);

    const handleReset = () => {
        setInputSource({ type: 'local', file: null });
        setGeneratedScript('');
        setError(null);
        setIsLoading(false);
    };

    return (
        <div className="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center p-4 sm:p-6 lg:p-8">
            <div className="w-full max-w-4xl mx-auto">
                <Header />
                <main className="mt-8 space-y-8">
                    {generatedScript && (
                        <div className="text-center">
                            <button
                                onClick={handleReset}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300"
                            >
                                Start Over
                            </button>
                        </div>
                    )}
                    
                    {!generatedScript && !isLoading && (
                        <div className="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 space-y-6">
                            <InputSourcePanel value={inputSource} onChange={setInputSource} />
                            {isReadyToConfigure && (
                                <ConversionOptionsPanel
                                    onGenerate={handleGenerateScript}
                                    isLoading={isLoading}
                                />
                            )}
                        </div>
                    )}

                    {isLoading && <Loader />}
                    
                    {error && (
                        <div className="bg-red-900/50 border border-red-700 text-red-300 p-4 rounded-lg text-center">
                            <p className="font-semibold">Error</p>
                            <p>{error}</p>
                        </div>
                    )}

                    {generatedScript && (
                        <ResultDisplay script={generatedScript} />
                    )}

                    <footer className="text-center text-gray-500 text-sm mt-12 pb-4">
                        <p>Generated by a world-class frontend React engineer with Gemini API.</p>
                        <p>This tool generates scripts but does not execute them. Always review scripts before running them locally.</p>
                    </footer>
                </main>
            </div>
        </div>
    );
};

export default App;
